---
title: "Host-Pathogen Sharing Workflow Data"
author: "Emily M. Lachtara"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# Load required packages
library(readxl)
library(janitor)
library(dplyr)
library(ggplot2)
library(tidyr)
library(kableExtra)
library(readxl)
library(readr)
source('functions/Sharing_index.R')

# Define color pallette
mypal <- cbind(palette(RColorBrewer::brewer.pal(n = 8, name = "Set2")),
               palette(RColorBrewer::brewer.pal(n = 12, name = "Paired")))
```

```{r Data wrangle}
# Read in Data
fam1 <- read_excel("data/m_hood_fams.xlsx", sheet = "Sheet1") %>% clean_names() 
fam2 <- read_excel("data/m_hood_fams.xlsx", sheet = "Sheet2") %>% clean_names()
fam3 <- read_excel("data/m_hood_fams.xlsx", sheet = "Sheet3") %>% clean_names() 
all_fams <- rbind(fam1, fam2, fam3)

all_order <- unique(all_fams$hostfam)

# Synonymy Correction
# Read in keys, replace raw name with new name
# Plants name correction
plants_key <- read_excel("data/key.xlsx", sheet = "plants")
id <- match(all_fams$host, plants_key$raw_name)
all_fams$host <- plants_key$new_name[id]
rm(id)

# Pathogen name correction
fungi_key <- read_excel("data/key.xlsx", sheet = "fungi")
id <- match(all_fams$sci_name, fungi_key$raw_name)
all_fams$sci_name <- fungi_key$new_name[id]
rm(id)

# Remove duplicate entries
clean_pathogen <- all_fams %>% select(sci_name, host) %>% distinct()

# Genus host, genus pathogen
genus_genus <- clean_pathogen %>% separate(host, c('host', 'species') , sep = " ") %>% separate(sci_name, c('sci_name', 'species2') , sep = " ") %>%
  select(-species, -species2) %>% distinct

# Genus host, species pathogen
genus_species <- clean_pathogen %>% separate(host, c('host', 'species') , sep = " ") %>% filter(!grepl('sp.', sci_name)) %>% select(-species) %>% distinct()

# Species host, species pathogen
species_species <- clean_pathogen %>% filter(!grepl('sp.', host)) %>% filter(!grepl('sp.', sci_name))%>% distinct()

# Species host, genus pathogen
species_genus <- clean_pathogen %>% filter(!grepl('sp.', host)) %>% filter(!grepl('sp.', sci_name)) %>% separate(sci_name, c('sci_name', 'species2') , sep = " ") %>%
  select(-species2) %>%  distinct()

# Read in WOS
WOS_citations <- read_csv("data/WOS/WOS citations - Sheet1.csv")
WOS_species <- WOS_citations %>% rename(host = Host) %>% select(host, WOS)
WOS_genus <- WOS_citations %>% separate(Host, c('host', 'species2') , sep = " ") %>% 
  group_by(host) %>% 
  summarize(WOS = sum(WOS))

# Join WOS with other
species_species <- full_join(species_species, WOS_species, by = "host")
species_genus <- full_join(species_genus, WOS_species, by = "host")
genus_species <- full_join(genus_species, WOS_genus, by = "host")
genus_genus <- full_join(genus_genus, WOS_genus, by = "host")

# Save the cleaned/corrected data
save(genus_genus, genus_species, species_species, species_genus, file = "data/clean_pathogen.rda")

```

```{r Create Jaccard Index}
# Load in clean data if needed
load("data/clean_pathogen.rda")

# Get pathogen sharing index
get_sharing(data = genus_genus, path_to_save = "data/sharing/genus.sharing.rda")
get_sharing(data = species_species, path_to_save = "data/sharing/species.sharing.rda")
get_sharing(data = genus_species, path_to_save = "data/sharing/genus.sp.sharing.rda")
get_sharing(data = species_genus, path_to_save = "data/sharing/species.gen.sharing.rda")
```

```{r WOS distribution}
# Load pathogen data
load("data/clean_pathogen.rda")

# Genus WOS plot
p1 <- genus_genus %>%
  select(host, WOS) %>%
  distinct(host, .keep_all = TRUE) %>%
  ggplot(aes(x = log(WOS))) +
  geom_density(fill = mypal[9])+
  theme_minimal()+
  labs(y = "Count", x = "log(WOS Citations)")+
  labs(title = "WOS Citations by Genus")+
  theme(plot.title = element_text(hjust = 0.5, size = 13, face = "bold"),
        axis.title.y = element_text(size = 12, face = "bold"),
        axis.title.x = element_text(size = 12, face = "bold"),
        axis.text.x = element_text(size = 10),
        axis.text.y = element_text(size = 10),
        legend.position = "none")

ggsave("figures/WOS/genus.pdf",
       plot = p1,
       units = "in",
       width = 6,
       height = 5,
       useDingbats = FALSE)

p2 <- species_species %>%
  select(host, WOS) %>%
  distinct(host, .keep_all = TRUE) %>%
  ggplot(aes(x = log(WOS))) +
  geom_density(fill = mypal[13])+
  theme_minimal()+
  labs(y = "Count", x = "log(WOS Citations)")+
  labs(title = "WOS Citations by Species")+
  theme(plot.title = element_text(hjust = 0.5, size = 13, face = "bold"),
        axis.title.y = element_text(size = 12, face = "bold"),
        axis.title.x = element_text(size = 12, face = "bold"),
        axis.text.x = element_text(size = 10),
        axis.text.y = element_text(size = 10),
        legend.position = "none")

ggsave("figures/WOS/species.pdf",
       plot = p2,
       units = "in",
       width = 6,
       height = 5,
       useDingbats = FALSE)
```

```{r Visualize pathogen sharing}
# Genus host, genus pathogen
load("data/sharing/genus.sharing.rda")
p1 <- as.data.frame(sharing) %>%
  mutate(percent = as.numeric(shared)/(as.numeric(org1.count) + as.numeric(org2.count))) %>%
  filter(percent > 0) %>% 
  ggplot(aes(x = percent))+
  geom_density(fill = mypal[8])+
  theme_minimal()+
  labs(y = "Count", x = "Jaccard Index")+
  labs(title = "Host pathogen sharing (Genus-Genus)")+
  theme(plot.title = element_text(hjust = 0.5, size = 13, face = "bold"),
        axis.title.y = element_text(size = 12, face = "bold"),
        axis.title.x = element_text(size = 12, face = "bold"),
        axis.text.x = element_text(size = 10),
        axis.text.y = element_text(size = 10),
        legend.position = "none")
ggsave("figures/JAC/genus.genus.pdf",
       plot = p1,
       units = "in",
       width = 6,
       height = 5,
       useDingbats = FALSE)

# Genus host, species pathogen
load("data/sharing/genus.sp.sharing.rda")
p2 <- as.data.frame(sharing) %>%
  mutate(percent = as.numeric(shared)/(as.numeric(org1.count) + as.numeric(org2.count))) %>%
  filter(percent > 0) %>% 
  ggplot(aes(x = percent))+
  geom_density(fill = mypal[4])+
  theme_minimal()+
  labs(y = "Count", x = "Jaccard Index")+
  labs(title = "Host pathogen sharing (Genus-Species)")+
  theme(plot.title = element_text(hjust = 0.5, size = 13, face = "bold"),
        axis.title.y = element_text(size = 12, face = "bold"),
        axis.title.x = element_text(size = 12, face = "bold"),
        axis.text.x = element_text(size = 10),
        axis.text.y = element_text(size = 10),
        legend.position = "none")
ggsave("figures/JAC/genus.sp.pdf",
       plot = p2,
       units = "in",
       width = 6,
       height = 5,
       useDingbats = FALSE)

# Species host, species pathogen
load("data/sharing/species.sharing.rda")
p3 <- as.data.frame(sharing) %>%
  mutate(percent = as.numeric(shared)/(as.numeric(org1.count) + as.numeric(org2.count))) %>%
  filter(percent > 0) %>% 
  ggplot(aes(x = percent))+
  geom_density(fill = mypal[2])+
  theme_minimal()+
  labs(y = "Count", x = "Jaccard Index")+
  labs(title = "Host pathogen sharing (Species-Species)")+
  theme(plot.title = element_text(hjust = 0.5, size = 13, face = "bold"),
        axis.title.y = element_text(size = 12, face = "bold"),
        axis.title.x = element_text(size = 12, face = "bold"),
        axis.text.x = element_text(size = 10),
        axis.text.y = element_text(size = 10),
        legend.position = "none")
ggsave("figures/JAC/species.pdf",
       plot = p3,
       units = "in",
       width = 6,
       height = 5,
       useDingbats = FALSE)

# Species host, genus pathogen
load("data/sharing/species.gen.sharing.rda")
p4 <- as.data.frame(sharing) %>%
  mutate(percent = as.numeric(shared)/(as.numeric(org1.count) + as.numeric(org2.count))) %>%
  filter(percent > 0) %>% 
  ggplot(aes(x = percent))+
  geom_density(fill = mypal[1])+
  theme_minimal()+
  labs(y = "Count", x = "Jaccard Index")+
  labs(title = "Host pathogen sharing (Species-Genus)")+
  theme(plot.title = element_text(hjust = 0.5, size = 13, face = "bold"),
        axis.title.y = element_text(size = 12, face = "bold"),
        axis.title.x = element_text(size = 12, face = "bold"),
        axis.text.x = element_text(size = 10),
        axis.text.y = element_text(size = 10),
        legend.position = "none")
ggsave("figures/JAC/species.gen.pdf",
       plot = p4,
       units = "in",
       width = 6,
       height = 5,
       useDingbats = FALSE)
```

```{r Initial, echo =  FALSE, warning = FALSE}
# Total observations per family
all_fams %>% group_by(Fam) %>% 
  count() %>% 
  rename('Total' = n) %>%
  kable(caption = "Total observations per family") %>% 
  kable_classic(full_width = F, html_font = "Cambria")

# Unique Hosts and Pathogens
hosts <- all_fams %>% select(Fam, host) %>%
  unique() %>% 
  group_by(Fam) %>% 
  count() %>% 
  rename('Hosts' = n)
pathogens <- all_fams %>% select(Fam, sci_name) %>% 
  unique() %>% 
  group_by(Fam) %>% 
  count() %>% 
  rename('Pathogens' = n) 

# Plot of host and pathogen numbers by Family
cbind(hosts, pathogens[,2]) %>% gather(key = 'Type', value = 'Value', 2:3)  %>%
  ggplot(aes(x = Fam, y = Value, fill = Type)) +
  geom_col(position = "dodge")+
  scale_fill_manual(values = mypal[4:5])+
  theme_minimal()+
  labs(y = "Count", x = "Family", fill = "")+
  labs(title = "Number of unique hosts and pathogens by Family")+
  theme(plot.title = element_text(hjust = 0.5, size = 13, face = "bold"),
        axis.title.y = element_text(size = 12, face = "bold"),
        axis.title.x = element_text(size = 12, face = "bold"),
        axis.text.x = element_text(size = 10),
        axis.text.y = element_text(size = 10),
        legend.position = "bottom")

# Plot of literature effort by Family
ggplot(all_fams, aes(x = as.numeric(litnum), col = Fam))+
  geom_density()+
  scale_colour_manual(values = mypal[4:6])+
  theme_minimal()+
  labs(y = "Count", x = "Literature Effort", col = "")+
  labs(title = "Distribution of literature effort by Family")+
  theme(plot.title = element_text(hjust = 0.5, size = 13, face = "bold"),
        axis.title.y = element_text(size = 12, face = "bold"),
        axis.title.x = element_text(size = 12, face = "bold"),
        axis.text.x = element_text(size = 10),
        axis.text.y = element_text(size = 10),
        legend.position = "bottom")
```



